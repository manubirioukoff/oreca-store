<?php
function getStars($category) {
    $productCollection = Mage::getResourceModel('catalog/product_collection')
                           ->addCategoryFilter($category)
			    ->addAttributeToSelect('produitstar');

$tabstars = array();
foreach($productCollection as $product) {
    
    if($product->produitstar == 1) {
	$tabstars[] = $product->getId();
    }
}

shuffle($tabstars);

return $tabstars;
}

function getBestsales($category) {
$best500 = array('44516','44518','8SPSS37','1772-004-100','171600','8SP0SN41','8SPSS13','8EQ065692','CATCOMP12','E1656','8OR00RB1F','8OR00RB93','RBF600','622029','613280','614014NA','F595RSR1955015','8SP04502','RBR12_CAS_TEA','RSP11_STYLO','613792R','8EQ00993','8SP00120543NR','8SP00120243NR','HW32050','80016D','6136043','424160','615000','63809000','F595RSR2054516','8SP15082','E1655','E1504','PRO/2BOMB','8SP002231BICE','8SP001511B4243','8SP00120843NR','434200','444100','451NH01','RBR11_CAS_RAC_N','STAGE_BPT_R8','TRANSFERTOS250BO','STAGE_OPT_PASS_ACC','STAGE_OPT_PASS_SUP','STAGE_OPTION_CADO','RSP11_CHE_MC_XL','STAGE_2_F430GAL_3T','E1653','8EQ42215','8SP150100','8SP00148','414JRP4039','414MT001D','4800','545PFF60301','201060','39027','662603116','6250511','8OMPDB459','414MT012','545PFR5306','205050','545PFF54601','634160','8619016','8OMPSC610M','8SP00120844NR','8SP00120241NR','8SP00120242NR','8OR01016N','8SP00120444NRGR','COL1222W3','COL4060W3','COL140160W3','E1502R','PSORECAN150X10','8OR06000005','8SP00120243AZ','8SP00120245NR','8OMPSC610L','8OR00RB95','8302018C','8EQ00108','615117','6460000','662607112','460010','414MT025','424150','451NET1','8EQ00538','8OR00RB95/150','623004','231K894R','613792N','460006','8SP12582','8SP01606AS','8SP02499P','8SP00120544NR','COL150170W3','RBR11_TSH_REF_XL','RSP12_PCLES_CITY','SOURI_PSC_BLANC','VMM11_PLO_TEA_XXL','CAMLOC-26S8-2D','CARBON50X20','904070NP          ','8SP02499','FER12_TSH_CR_XL','M22UAN8','MGP11_CAS_ROSB','FPA906','8OMPDA80161','8EQ404412','8SP00120542NR','8SP00120643NRBI','8SP00135410AZ','8SP01608','8SP00120846NR','8SP002002NL','8SP00206NL','8SP00490N','414MT024','460001','545PFR5300','545PFR5305','545PFR530818','545PFR550420','414401180','41480145','205076','205080','21565','185006','185EE200','662112088','7126022667','7126540067','712S47061','65330480','545PFF6020722','622LPCOMFF1','50923P','545PFF3501','545PFF5301','545PFF530222','545PFF5460224','545PFF6020223','622022','622025RA','622026','861SHL16','8EQ014GPHD2','12995','39028','460029','545PFR53608','6003','6003BK','607T024','205070','231K03','3060322P','3110C03','1DV4246A7','1PFEDOTSF','1PFEH558','1822050','1DV00477','1PFCL4017','1PFCL4034R5','653005','642002','622115','622885','623100','615800120','545PFF5601','482','614014','8EQ014COACH','8EQ0304','8EQ014SUP','8OR0095','8OR1036','8OMPIB751NL','8SP00120443NRBI','8SP00120443NRGR','8SP00120444NRBI','8SP00120143NR','8SP00120145NR','8SP00120240AZ','8SP00120543BI','8SP00120544BI','8SP00120546NR','8SP00139F210N','8SP01606AA','8SP00120842NR','8SP03791R','8SP00827FNR','RBF660','RBR11_BEAN_VET','KITSECU','RSP11_CHE_MC_L','RBR12_CHH_TEA_XL','RBR12_IPOD','RBR12_TSH_FON_L','FER12_TSE_CR_4','COL2032W3','COL2540W3','COLE6368W1','BN021423','CAMLOC-2600-LW','ANR80','8TO001201N43','8TO001201N44','999115015','V212/12','RSP11_SSH_L','STAGE_BAPT_R8_2T','STAGE_PZE_SPA','STICKERORVISIERE','RSP11_SSH_M','VHTRIPSOND0012','VMM11_CAS_BUT','VMM11_PLO_TEA_S','VMM12_CAS_BLK','VMM12_TSH_TEA_XXL','VO1525211','ADAP16150','AT18050X50NO','8TO001201N42','CIT11_SWEAT_S','CP214219','FER12_VSH_CVN_L','FER12_VSH_SMN_M','FER12_VSH_SMN_XL','GUL10_MUG_B','GUL11_CAR_GREY_S','GUL11_SAC_ORI','GUL12_CHH_GPO_42','GUL12_CHH_GPO_44','JCS11','FER11_PCL_CUI','FER11_TSF_VR_L','FER12_SWH_ZR_L','RBR12_TSH_TEA_M','RSP11_CAS','RBR12_SSH_TEA_XL','RBR12_SSH_TEA_XXL','RBR12_TSE_TEA_4','RSP11_CHE_MC_XXL','RSP11_CHE_ML_L','RSP11_MONTRE','RSP11_PAN_T42','RSP12_PLH_B_M','RSP12_PLH_N_XL','STAGE_2_F430GT3_6T','LRG11_PAR_GOLF','MGP11_PBJ_TEA_M','MGP11_TSH_SCH_XXL','MGP12_CAS_FANN','MST11_SWE_MAT_XXL','RBR12_CEI_HARN','PK4R1757015','PK4R1757015D','RBR11_CAS_RAC_W','RBR11_TSE_REF_140','RBR11_TSH_LOG_B_XL','RBR11_TSH_LOG_W_XL','8SP01023N','8SP01045NR','8SP015NE981','8SP00253207BI','8SP00253210NR','8SP0033082M','8SP00499058SX','8SP00823R','8SP12562','8SP01606AR','8SP01606ASSP','8SP00139F211B','8SP00139F28N','8SP00139F309NR','8SP00144','8SP00149','8SP001511B4041','8SP00120445NRGR','8SP00120541NR','8SP00135409AZ','8SP00135410NR','8SP001511B4445','8SP00162N','8SP0017612MICEN4XL','8SP00177MBIS','8SP00177MBIXL','8SP002002BL','8SP00202GM','8SP00202GS','8SP002092NM','8SP00120643RSBI','8SP00120837RS','8SP00120840NR','8SP00120841AZ','8SP00124843N','8SP00124843R','8SP00124846A','8SP001352A10B','8SP00120844RS','8SP00120KP41R','8SP00120PLBC37BEBE','8SP001241N45','8SP001244SL42R','8SP00124743NRSI','8OR0604480702','8SP00120441BIGR','8SP00120441NRBI','8SP00120442NRBI','8SP00120443BIGR','8OMPIB753NXL','8OMPKK0171407144','8OMPKK02736176M','8OMPNB1867L','8OMPSC607M','8OMPSC607XL','8OMPSC611M020','8OMPSC770S020','8OR00600','8OR0089','8PR00106NXL','8SP001052BM','8SP001086B56','8SP001086X58BB','8OR00RB86','8EQ0303','8OMPDA508041','8OMPIA0182607050','8OMPIAA/729','8EQ014MINSOL','8EQ0050','8302018S','881861999853      ','615114M','613997R','615913C','616162','621021','622025','615360','615429C','615435C','625BKR6EIX','622886','642115B','6460017','660KTS40','661011','661014','6622515C182       ','712R18221','712S47051','811105','829FILM2','1PFCL4046','1PFCL4084','1PFCL4140R5','1PFCL900','1PFDS1399','1PFEDOT5','1DV00518','1822055','1822062','1772-008-100','1822030','10000838','113BSP1/2','116AN8','1PFEH876','1PFET1399','1PFPA587','1RSEB03','1DVHPD478','1DVHPD547','1DVHPD552','1FL9105K','1FL9200K','3600810029010','39020','231K30','231K895','246063012001G','2K8686','607T040','608001','61022','613110','613111','613130','607DA0210BG2BL','607H20LSS','4715','4805','480532','460025','460026','451K370','41199','1FL9666K','1PFCL2340','431300','44231P','451P549205','451R434000','460005','8EQ0206','8EQ0360109','8EQ014GPHD','8EQ0046','8OMPIA0182807158','8OMPIAA730L','8OMPIB747ML','8OMPIB747MM','8OMPIC78504139','8OMPKK01711E07054','8OMPKK0171404144','8OMPKK0171406144','8OR713526','8PR00106NL','8SP001086R56','8SP001086R58','8SP001086X50BB','8SP001086X50RB','8SP001086X52BB','8SP001088X56NG','8SP00120242AZ','8OMPKK0171614750','8OMPKK02735060M','8OMPKK02735071XL','8OMPKK02738220S','8OMPKK02738221M','8OMPKK03005041','8OMPOA1000','8OMPOA1010','8OMPORC3401016T44','8OMPSC770L020','622024','545PFF60206K','622HIDBIH4','627PE205P','632100','632101','634142','642005','6460024','661003IN','661009','661021','661032','661054IN','661083IN','662605330','70011052C','712390000','726ST3111','749331P','8302039S','1DV00547','1DV00724','1DV00917','1FL9260K','1FL9261K','1FL9591K','1FL9676K','1PFCL4000','1PFCL4026RC8','1PFCL4050','1PFCL4070','1PFCL4077','1PFDS876','1PFEH072','1PFEH1334','1PFEH1491','1PFEH406','1PFET392','231K589','1772-010-100','1822082','1822083','1822088C','1823015','413900','2779','3110C','152002C','60726511004','60726601004');
    $productCollection = Mage::getResourceModel('catalog/product_collection')
                           ->addCategoryFilter($category);

$tabbestsales = array();
foreach($productCollection as $product) {
    if ($product->isConfigurable()) {
	$childProducts = Mage::getModel('catalog/product_type_configurable')
                        ->getUsedProducts(null,$product);
	foreach ($childProducts as $child) {
	    if (in_array($child->getSku(), $best500) && $product->isSaleable()) {
		$tabbestsales[] = $product->getId();
	    }
	}
    }
    else {
	if (in_array($product->getSku(), $best500) && $product->isSaleable()) {
	    $tabbestsales[] = $product->getId();
	}
    }
}

//shuffle($tabbestsales);

return $tabbestsales;
}

$curcat = Mage::registry('current_category');


//$sousCategories2 = Mage::getModel('catalog/category')->getCategories( $curcat->getId(), 1, 'true|position' );
//$sousCategories = $sousCategories2->getNodes();
//$tabcats = array('35','36','37','38','39','41','445','40','43','1262');


//if ($curcat->getId() == '34') { $tabcats = array('35','36','37','38','39','41','445','40','43','1262'); }
?>
<?php
$tabsmallcats = array();
foreach($curcat->getChildrenCategories() as $childcat) {
    $catid = $childcat->getId();
    $cat = Mage::getModel('catalog/category')->load($catid);
    $prods = Mage::getResourceModel('catalog/product_collection')
                           ->addCategoryFilter($cat)
			   ->addAttributeToSelect('image')
			    ->setPageSize(1);
    $tabstars = getStars($cat);
    $tabbestsales = getBestsales($cat);
    foreach($prods as $prod) {
	$productimage = Mage::getModel('core/layout')->helper('catalog/image')->init($prod, 'image')->resize(220, 220);
    }
    //$prod = $prods[0];
    //var_dump($prods);
    if(count($tabstars) >= 3 && count($tabbestsales) >= 3) {
?>
<div class="landing-cat">
    <div class="landing-vignette" style="margin-left:7px;">
	<div class="landing-vignette-titre">
	    <h2><a href="<?php echo $cat->getUrl(); ?>"><?php echo $cat->getName(); ?></a></h2>
	</div>
	<a href="<?php echo $cat->getUrl(); ?>"><img style="margin-left:8px;" src="<?php echo $productimage; ?>" /></a>
	<div class="landing-vignette-link">
	   <span style="color:#FA7206">></span><a href="<?php echo $cat->getUrl(); ?>"> Voir tous les produits</a>
	</div>
    </div>
    <div class="landing-main">
	<div class="landing-cat-miseenavant-container">
	<div class="landing-cat-selection-container">
	    <div class="landing-cat-selection-titre">
		SELECTION ORECA
	    </div>
	    <div class="landing-hpproducts-passion">
	<?php
	for($i=0; $i<3; $i++) {
	    //echo $prod->getSku()." - ".$prod->getParentEnfant()."<br />";
	    //$sku = $tabfinalshopping[$i];
	    //$prod = Mage::getModel('catalog/product')->loadByAttribute('sku',$sku);
	    $entity_id = $tabstars[$i];
	    $prod = Mage::getModel('catalog/product')->load($entity_id);
	    $productimage = Mage::getModel('core/layout')->helper('catalog/image')->init($prod, 'image')->resize(115, 115);
	    $marque = $prod->getResource()->getAttribute('global_marques')->getFrontend()->getValue($prod);
	    $marqueimg = strtr($marque, " ", "-");
	    $finalprice = Mage::helper('tax')->getPrice($prod, $prod->getFinalPrice(), true);
	    $regularprice = Mage::helper('tax')->getPrice($prod, $prod->getPrice(), true);
	    $opmkg = $prod->getResource()->getAttribute('global_op_mkg')->getFrontend()->getValue($prod);


	    // A partir de
	    $affichapartirde = 'display:none;';

	    if($prod->getTypeId() == 'configurable') {
		$childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $prod);
		//echo "childids";
		//var_dump($childProducts);
		$tabprices = array();

		foreach ($childProducts as $child) {
		    //echo "sku : ".$child->getSku()." - price : ".$child->getFinalPrice()." - status : ".$child->getStatus()." - isinstock : ".$child->getStockItem()->getIsInStock()."<br />";
		    if($child->getStatus() == 1 && $child->getStockItem()->getIsInStock() != 0) {
			$tabprices[] = $child->getFinalPrice();
		    }
		}
		sort($tabprices);
		$lastprice = count($tabprices) - 1;
		//var_dump($tabprices);
		if ($tabprices[0] != $tabprices[$lastprice]) {
		    $affichapartirde = 'display:block;';
		    $finalprice = Mage::helper('tax')->getPrice($prod, $tabprices[0], true);
		}
	    }

	    // En promo ?
	    $displaypastille = "display:none;";
	    $pcentpromo = 0;
	    if ($regularprice > $finalprice) {
		$displaypastille = "display:block;";
		$pcentpromo = round((100 - ((100*$finalprice)/$regularprice)),0);
	    }

	?>

	<div class="hpbestsales-vignette" onclick="window.location.href='<?php echo $prod->getProductUrl(); ?>';">
	    <div class="vignprod-<?php echo $opmkg; ?>"></div>

	    <div class="hpbestsales-photo">
		<img title="<?php echo $prod->getName(); ?>" alt="<?php echo $prod->getName(); ?>" src="<?php echo $productimage; ?>" width="115" height="115" />
	    </div>
	    <div class="hpbestsales-name">
		<a href="<?php echo $prod->getProductUrl(); ?>" onclick="disabledEventPropagation(event);"><?php echo $prod->getName(); ?></a>
	    </div>
	    <div class="hpbestsales-pastillepromo" style="<?php echo $displaypastille; ?>">
		<div class="remise-texte">-<?php echo $pcentpromo; ?></div><div class="remise-pcent">%</div>
	    </div>
	    <div class="hpbestsales-prix">
		<div class="apartirde" style="display:none;">A partir de</div>
		<div class="prix-barre" style="<?php echo $displaypastille; ?>"><?php echo Mage::helper('core')->currency($regularprice,true,false); ?></div>
		<div class="prix-normal"><?php echo Mage::helper('core')->currency($finalprice,true,false); ?></div>
	    </div>
	</div>
	<?php
	}
	?>
    </div>
	</div>

	<div class="landing-cat-bestsales-container">
	    <div class="landing-cat-bestsales-titre">
		MEILLEURES VENTES
	    </div>
	    <div class="landing-hpproducts-passion">
	<?php
	for($i=0; $i<3; $i++) {
	    //echo $prod->getSku()." - ".$prod->getParentEnfant()."<br />";
	    //$sku = $tabfinalshopping[$i];
	    //$prod = Mage::getModel('catalog/product')->loadByAttribute('sku',$sku);
	    $entity_id = $tabbestsales[$i];
	    $prod = Mage::getModel('catalog/product')->load($entity_id);
	    $productimage = Mage::getModel('core/layout')->helper('catalog/image')->init($prod, 'image')->resize(115, 115);
	    $marque = $prod->getResource()->getAttribute('global_marques')->getFrontend()->getValue($prod);
	    $marqueimg = strtr($marque, " ", "-");
	    $finalprice = Mage::helper('tax')->getPrice($prod, $prod->getFinalPrice(), true);
	    $regularprice = Mage::helper('tax')->getPrice($prod, $prod->getPrice(), true);
	    $opmkg = $prod->getResource()->getAttribute('global_op_mkg')->getFrontend()->getValue($prod);
	    if ($opmkg == 'promotion') {
		$opmkg = "";
	    }

	    // A partir de
	    $affichapartirde = 'display:none;';

	    if($prod->getTypeId() == 'configurable') {
		$childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $prod);
		//echo "childids";
		//var_dump($childProducts);
		$tabprices = array();

		foreach ($childProducts as $child) {
		    //echo "sku : ".$child->getSku()." - price : ".$child->getFinalPrice()." - status : ".$child->getStatus()." - isinstock : ".$child->getStockItem()->getIsInStock()."<br />";
		    if($child->getStatus() == 1 && $child->getStockItem()->getIsInStock() != 0) {
			$tabprices[] = $child->getFinalPrice();
		    }
		}
		sort($tabprices);
		$lastprice = count($tabprices) - 1;
		//var_dump($tabprices);
		if ($tabprices[0] != $tabprices[$lastprice]) {
		    $affichapartirde = 'display:block;';
		    $finalprice = Mage::helper('tax')->getPrice($prod, $tabprices[0], true);
		}
	    }

	    // En promo ?
	    $displaypastille = "display:none;";
	    $pcentpromo = 0;
	    if ($regularprice > $finalprice) {
		$displaypastille = "display:block;";
		$pcentpromo = round((100 - ((100*$finalprice)/$regularprice)),0);
		$opmkg = 'promotion';
	    }

	?>

	<div class="hpbestsales-vignette" onclick="window.location.href='<?php echo $prod->getProductUrl(); ?>';">
	    <div class="vignprod-<?php echo $opmkg; ?>"></div>

	    <div class="hpbestsales-photo">
		<img title="<?php echo $prod->getName(); ?>" alt="<?php echo $prod->getName(); ?>" src="<?php echo $productimage; ?>" width="115" height="115" />
	    </div>
	    <div class="hpbestsales-name">
		<a href="<?php echo $prod->getProductUrl(); ?>" onclick="disabledEventPropagation(event);"><?php echo $prod->getName(); ?></a>
	    </div>
	    <div class="hpbestsales-pastillepromo" style="<?php echo $displaypastille; ?>">
		<div class="remise-texte">-<?php echo $pcentpromo; ?></div><div class="remise-pcent">%</div>
	    </div>
	    <div class="hpbestsales-prix">
		<div class="apartirde" style="display:none;">A partir de</div>
		<div class="prix-barre" style="<?php echo $displaypastille; ?>"><?php echo Mage::helper('core')->currency($regularprice,true,false); ?></div>
		<div class="prix-normal"><?php echo Mage::helper('core')->currency($finalprice,true,false); ?></div>
	    </div>
	</div>
	<?php
	}
	?>
    </div>
	</div>
    </div>
    </div>
</div>
<?php
    }
    else {
	$tabsmallcats[] = $cat->getId();
    }
}


foreach($tabsmallcats as $catid) {
    $cat = Mage::getModel('catalog/category')->load($catid);
    $prods = Mage::getResourceModel('catalog/product_collection')
                           ->addCategoryFilter($cat)
			   ->addAttributeToSelect('image')
			    ->setPageSize(1);
    foreach($prods as $prod) {
	$productimage = Mage::getModel('core/layout')->helper('catalog/image')->init($prod, 'image')->resize(220, 220);
    }
    ?>
    <div class="landing-vignette" style="margin:7px;">
	<div class="landing-vignette-titre">
	    <h2><a href="<?php echo $cat->getUrl(); ?>"><?php echo $cat->getName(); ?></a></h2>
	</div>
	<a href="<?php echo $cat->getUrl(); ?>"><img style="margin-left:8px;" src="<?php echo $productimage; ?>" /></a>
	<div class="landing-vignette-link">
	   <span style="color:#FA7206">></span><a href="<?php echo $cat->getUrl(); ?>"> Voir tous les produits</a>
	</div>
    </div>
    
<?php
}
?>
